name: Process Daily Calls (Dev Tier)

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      date:
        description: 'Date to process (YYYY-MM-DD)'
        required: false
        type: string

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hour timeout
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ringcentral python-dotenv requests
    
    - name: Test Dev Tier Keys
      env:
        GROQ_API_KEY_1: ${{ secrets.GROQ_API_KEY_1 }}
        GROQ_API_KEY_2: ${{ secrets.GROQ_API_KEY_2 }}
        GROQ_API_KEY_3: ${{ secrets.GROQ_API_KEY_3 }}
        GROQ_API_KEY_4: ${{ secrets.GROQ_API_KEY_4 }}
        GROQ_API_KEY_5: ${{ secrets.GROQ_API_KEY_5 }}
        GROQ_API_KEY_6: ${{ secrets.GROQ_API_KEY_6 }}
        GROQ_API_KEY_7: ${{ secrets.GROQ_API_KEY_7 }}
        GROQ_API_KEY_8: ${{ secrets.GROQ_API_KEY_8 }}
        GROQ_API_KEY_9: ${{ secrets.GROQ_API_KEY_9 }}
        GROQ_API_KEY_10: ${{ secrets.GROQ_API_KEY_10 }}
        GROQ_API_KEY_11: ${{ secrets.GROQ_API_KEY_11 }}
        GROQ_API_KEY_12: ${{ secrets.GROQ_API_KEY_12 }}
        GROQ_API_KEY_13: ${{ secrets.GROQ_API_KEY_13 }}
        GROQ_API_KEY_14: ${{ secrets.GROQ_API_KEY_14 }}
        GROQ_API_KEY_15: ${{ secrets.GROQ_API_KEY_15 }}
        GROQ_API_KEY_16: ${{ secrets.GROQ_API_KEY_16 }}
        GROQ_API_KEY_17: ${{ secrets.GROQ_API_KEY_17 }}
        GROQ_API_KEY_18: ${{ secrets.GROQ_API_KEY_18 }}
        GROQ_API_KEY_19: ${{ secrets.GROQ_API_KEY_19 }}
        GROQ_API_KEY_20: ${{ secrets.GROQ_API_KEY_20 }}
        GROQ_API_KEY_21: ${{ secrets.GROQ_API_KEY_21 }}
        GROQ_API_KEY_22: ${{ secrets.GROQ_API_KEY_22 }}
        GROQ_API_KEY_23: ${{ secrets.GROQ_API_KEY_23 }}
        DEV_TIER_KEYS: ${{ secrets.DEV_TIER_KEYS }}
      run: |
        python test_dev_tier_keys.py
    
    - name: Process recordings
      env:
        # RingCentral credentials
        RC_CLIENT_ID: ${{ secrets.RC_CLIENT_ID }}
        RC_CLIENT_SECRET: ${{ secrets.RC_CLIENT_SECRET }}
        RC_JWT: ${{ secrets.RC_JWT }}
        RC_SERVER_URL: ${{ secrets.RC_SERVER_URL }}
        
        # All API keys
        GROQ_API_KEY_1: ${{ secrets.GROQ_API_KEY_1 }}
        GROQ_API_KEY_2: ${{ secrets.GROQ_API_KEY_2 }}
        GROQ_API_KEY_3: ${{ secrets.GROQ_API_KEY_3 }}
        GROQ_API_KEY_4: ${{ secrets.GROQ_API_KEY_4 }}
        GROQ_API_KEY_5: ${{ secrets.GROQ_API_KEY_5 }}
        GROQ_API_KEY_6: ${{ secrets.GROQ_API_KEY_6 }}
        GROQ_API_KEY_7: ${{ secrets.GROQ_API_KEY_7 }}
        GROQ_API_KEY_8: ${{ secrets.GROQ_API_KEY_8 }}
        GROQ_API_KEY_9: ${{ secrets.GROQ_API_KEY_9 }}
        GROQ_API_KEY_10: ${{ secrets.GROQ_API_KEY_10 }}
        GROQ_API_KEY_11: ${{ secrets.GROQ_API_KEY_11 }}
        GROQ_API_KEY_12: ${{ secrets.GROQ_API_KEY_12 }}
        GROQ_API_KEY_13: ${{ secrets.GROQ_API_KEY_13 }}
        GROQ_API_KEY_14: ${{ secrets.GROQ_API_KEY_14 }}
        GROQ_API_KEY_15: ${{ secrets.GROQ_API_KEY_15 }}
        GROQ_API_KEY_16: ${{ secrets.GROQ_API_KEY_16 }}
        GROQ_API_KEY_17: ${{ secrets.GROQ_API_KEY_17 }}
        
        # Specify dev tier keys
        DEV_TIER_KEYS: ${{ secrets.DEV_TIER_KEYS }}
      run: |
        if [ "${{ github.event.inputs.date }}" != "" ]; then
          python daily_call_processor_dev_tier.py --date ${{ github.event.inputs.date }}
        else
          python daily_call_processor_dev_tier.py
        fi
    
    - name: Upload results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: call-recordings-dev-tier
        path: daily_recordings_dev/
        retention-days: 30
    
    - name: Upload logs
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: processing-logs
        path: |
          *.log
        retention-days: 7
